# =====================================================================
# FAST Ghidra Install + Script Deployment (WebClient Optimized)
# =====================================================================

$ErrorActionPreference = "Stop"

# -------------------------------------------------------------------------------------------------
# Auto-bypass ExecutionPolicy
# -------------------------------------------------------------------------------------------------
if ($env:PSExecutionPolicyPreference -ne "Bypass" -and $MyInvocation.InvocationName -ne "") {
    powershell -ExecutionPolicy Bypass -File $MyInvocation.MyCommand.Definition
    exit
}

# -------------------------------------------------------------------------------------------------
# Configuration
# -------------------------------------------------------------------------------------------------
$downloadDir   = "$env:TEMP\ghidra_downloads"
$toolsDir     = "C:\tools"

# Ghidra download URL
$ghidraUrl    = "https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_11.3.2_build/ghidra_11.3.2_PUBLIC_20250415.zip"
$ghidraZip    = "$downloadDir\ghidra.zip"

$scriptUrls = @(
    "https://raw.githubusercontent.com/amohanta/Detection_Engineering_Tools/refs/heads/main/Ghidra_Scripts/Malware_Function_ReConer_v3.py",
    "https://raw.githubusercontent.com/amohanta/Detection_Engineering_Tools/refs/heads/main/Ghidra_Scripts/anti-techniques_detection.py"
)

# -------------------------------------------------------------------------------------------------
# Main Script
# -------------------------------------------------------------------------------------------------
$timer = [System.Diagnostics.Stopwatch]::StartNew()

Write-Host "=============================================" -ForegroundColor Cyan
Write-Host " Ghidra Setup (WebClient Optimized)" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan

# -------------------------------------------------------------------------------------------------
# System Checks
# -------------------------------------------------------------------------------------------------
Write-Host "`n[SYSTEM CHECK] Verifying requirements..." -ForegroundColor Cyan

# Check for Java
$javaCheck = Get-Command java -ErrorAction SilentlyContinue
if (-not $javaCheck) {
    Write-Host "  WARNING: Java not found!" -ForegroundColor Yellow
    Write-Host "  Ghidra requires Java 17+ to run." -ForegroundColor Yellow
    Write-Host "  Please install Java from: https://adoptium.net/" -ForegroundColor Yellow
    $continue = Read-Host "  Continue anyway? (y/n)"
    if ($continue -ne 'y') {
        exit
    }
} else {
    Write-Host "  OK: Java found" -ForegroundColor Green
}

# Check if Ghidra already exists
$existingGhidra = Get-ChildItem -Path $toolsDir -Directory -ErrorAction SilentlyContinue |
    Where-Object { $_.Name -like "ghidra*_PUBLIC*" } |
    Select-Object -First 1

if ($existingGhidra) {
    Write-Host "  INFO: Existing Ghidra found at: $($existingGhidra.FullName)" -ForegroundColor Yellow
    $overwrite = Read-Host "  Overwrite existing installation? (y/n)"
    if ($overwrite -ne 'y') {
        Write-Host "  Exiting..." -ForegroundColor Yellow
        exit
    }
    Remove-Item -Path $existingGhidra.FullName -Recurse -Force -ErrorAction SilentlyContinue
}

# -------------------------------------------------------------------------------------------------
# Create directories
# -------------------------------------------------------------------------------------------------
New-Item -Path $downloadDir -ItemType Directory -Force | Out-Null
New-Item -Path $toolsDir -ItemType Directory -Force | Out-Null

# -------------------------------------------------------------------------------------------------
# Download Ghidra ZIP using WebClient (Optimized)
# -------------------------------------------------------------------------------------------------
Write-Host "`n[DOWNLOAD] Downloading Ghidra ZIP..." -ForegroundColor Cyan

try {
    $webClient = New-Object System.Net.WebClient
    $webClient.DownloadFile($ghidraUrl, $ghidraZip)
    
    if (Test-Path $ghidraZip) {
        $fileSize = [math]::Round((Get-Item $ghidraZip).Length / 1MB, 2)
        Write-Host "  OK: Ghidra ZIP downloaded ($fileSize MB)" -ForegroundColor Green
    } else {
        throw "Download completed but file not found"
    }
} catch {
    Write-Host "  ERROR: Failed to download Ghidra!" -ForegroundColor Red
    Write-Host "  Details: $($_.Exception.Message)" -ForegroundColor Red
    exit
}

# -------------------------------------------------------------------------------------------------
# Extract Ghidra DIRECTLY into C:\tools
# -------------------------------------------------------------------------------------------------
Write-Host "`n[EXTRACT] Extracting Ghidra to C:\tools..." -ForegroundColor Cyan

try {
    Expand-Archive -LiteralPath $ghidraZip -DestinationPath $toolsDir -Force -ErrorAction Stop
    Write-Host "  OK: Extraction complete" -ForegroundColor Green
} catch {
    Write-Host "  ERROR: Failed to extract Ghidra!" -ForegroundColor Red
    Write-Host "  Details: $($_.Exception.Message)" -ForegroundColor Red
    exit
}

# -------------------------------------------------------------------------------------------------
# Locate ghidra_scripts folder
# -------------------------------------------------------------------------------------------------
Write-Host "`n[SETUP] Configuring Ghidra..." -ForegroundColor Cyan

$ghidraBaseDir = Get-ChildItem -Path $toolsDir -Directory |
    Where-Object { $_.Name -like "ghidra*_PUBLIC*" } |
    Select-Object -First 1

if (-not $ghidraBaseDir) {
    Write-Host "  ERROR: Ghidra directory not found!" -ForegroundColor Red
    exit
}

$ghidraScriptsDir = Join-Path $ghidraBaseDir.FullName "Ghidra\Features\Base\ghidra_scripts"

if (-not (Test-Path $ghidraScriptsDir)) {
    $ghidraScriptsDir = Join-Path $ghidraBaseDir.FullName "ghidra_scripts"
    
    if (-not (Test-Path $ghidraScriptsDir)) {
        Write-Host "  ERROR: ghidra_scripts directory not found!" -ForegroundColor Red
        Write-Host "  Searched paths:" -ForegroundColor Yellow
        Write-Host "    - $($ghidraBaseDir.FullName)\Ghidra\Features\Base\ghidra_scripts" -ForegroundColor Yellow
        Write-Host "    - $($ghidraBaseDir.FullName)\ghidra_scripts" -ForegroundColor Yellow
        exit
    }
}

Write-Host "  OK: ghidra_scripts located" -ForegroundColor Green

# -------------------------------------------------------------------------------------------------
# Download custom scripts using WebClient
# -------------------------------------------------------------------------------------------------
Write-Host "`n[DOWNLOAD] Custom Ghidra Scripts..." -ForegroundColor Cyan

foreach ($url in $scriptUrls) {
    $fileName = Split-Path $url -Leaf
    $destPath = Join-Path $ghidraScriptsDir $fileName
    
    try {
        $webClient = New-Object System.Net.WebClient
        $webClient.DownloadFile($url, $destPath)
        Write-Host "  OK: $fileName" -ForegroundColor Green
    } catch {
        Write-Host "  WARNING: Failed to download $fileName" -ForegroundColor Yellow
        Write-Host "  Details: $($_.Exception.Message)" -ForegroundColor Yellow
    }
}

# -------------------------------------------------------------------------------------------------
# Optional: Add to PATH
# -------------------------------------------------------------------------------------------------
Write-Host "`n[CONFIG] Optional Configuration..." -ForegroundColor Cyan

$addToPath = Read-Host "  Add Ghidra directory to system PATH? (y/n)"
if ($addToPath -eq 'y') {
    $ghidraDir = $ghidraBaseDir.FullName
    $currentPath = [Environment]::GetEnvironmentVariable("PATH", "User")
    
    if (-not $currentPath.Contains($ghidraDir)) {
        $newPath = "$currentPath;$ghidraDir"
        [Environment]::SetEnvironmentVariable("PATH", $newPath, "User")
        Write-Host "  OK: Added to user PATH (requires restart)" -ForegroundColor Green
    } else {
        Write-Host "  INFO: Ghidra already in PATH" -ForegroundColor Yellow
    }
}

# -------------------------------------------------------------------------------------------------
# Cleanup
# -------------------------------------------------------------------------------------------------
Write-Host "`n[CLEANUP] Removing temporary files..." -ForegroundColor Cyan

Remove-Item $ghidraZip -Force -ErrorAction SilentlyContinue
Remove-Item $downloadDir -Recurse -Force -ErrorAction SilentlyContinue

Write-Host "  OK: Cleanup complete" -ForegroundColor Green

# -------------------------------------------------------------------------------------------------
# Create shortcut (optional)
# -------------------------------------------------------------------------------------------------
$createShortcut = Read-Host "  Create desktop shortcut to Ghidra? (y/n)"
if ($createShortcut -eq 'y') {
    $ghidraRunPath = Join-Path $ghidraBaseDir.FullName "ghidraRun.bat"
    $shortcutPath = "$env:USERPROFILE\Desktop\Ghidra.lnk"
    
    if (Test-Path $ghidraRunPath) {
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut($shortcutPath)
        $Shortcut.TargetPath = $ghidraRunPath
        $Shortcut.WorkingDirectory = $ghidraBaseDir.FullName
        $Shortcut.Save()
        Write-Host "  OK: Desktop shortcut created" -ForegroundColor Green
    } else {
        Write-Host "  WARNING: ghidraRun.bat not found" -ForegroundColor Yellow
    }
}

# -------------------------------------------------------------------------------------------------
# Summary
# -------------------------------------------------------------------------------------------------
$timer.Stop()

Write-Host ""
Write-Host "=============================================" -ForegroundColor Green
Write-Host " Complete! Time: $([math]::Round($timer.Elapsed.TotalSeconds, 1))s" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host "  Ghidra Installed In: $($ghidraBaseDir.FullName)" -ForegroundColor White
Write-Host "  Scripts Directory: $ghidraScriptsDir" -ForegroundColor White
Write-Host "  Custom Scripts Installed:" -ForegroundColor White
foreach ($url in $scriptUrls) {
    $fileName = Split-Path $url -Leaf
    Write-Host "    - $fileName" -ForegroundColor White
}
Write-Host ""
Write-Host "  Next Steps:" -ForegroundColor Cyan
Write-Host "  1. Run: $($ghidraBaseDir.FullName)\ghidraRun.bat" -ForegroundColor Yellow
Write-Host "  2. In Ghidra, go to Window -> Script Manager" -ForegroundColor Yellow
Write-Host "  3. Refresh scripts and use the installed tools" -ForegroundColor Yellow
Write-Host "=============================================" -ForegroundColor Green
