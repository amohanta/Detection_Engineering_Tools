# =====================================================================
# HYPER-FAST Ghidra Installer (Parallel Download + Install)
# =====================================================================

$ErrorActionPreference = "SilentlyContinue"
$ProgressPreference = "SilentlyContinue"  # Disable slow progress bars

# ===================== Configuration =====================
$toolsDir = "C:\tools"
$downloadDir = "$env:TEMP\ghidra_downloads"
$ghidraScriptsDir = "$toolsDir\ghidra_scripts_temp"

# URLs
$javaUrl = "https://download.oracle.com/java/25/latest/jdk-25_windows-x64_bin.exe"
$ghidraUrl = "https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_12.0.2_build/ghidra_12.0.2_PUBLIC_20260129.zip"

$scriptUrls = @(
    "https://raw.githubusercontent.com/amohanta/Detection_Engineering_Tools/refs/heads/main/Ghidra_Scripts/Malware_Function_ReConer_v3.py"
    "https://raw.githubusercontent.com/amohanta/Detection_Engineering_Tools/refs/heads/main/Ghidra_Scripts/anti-techniques_detection.py"
)

# ===================== Main Script =====================
$timer = [System.Diagnostics.Stopwatch]::StartNew()

Write-Host ""
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "    HYPER-FAST GHIDRA INSTALLER" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "    • Parallel downloads" -ForegroundColor Gray
Write-Host "    • Concurrent extraction" -ForegroundColor Gray
Write-Host "    • Minimal overhead" -ForegroundColor Gray
Write-Host "=============================================" -ForegroundColor Cyan

# ===================== Phase 0: Pre-checks =====================
Write-Host "`n[CHECK] System verification..." -ForegroundColor Cyan

# Check/remove existing Ghidra
$existingGhidra = Get-ChildItem -Path $toolsDir -Directory -ErrorAction SilentlyContinue |
    Where-Object { $_.Name -like "ghidra*_PUBLIC*" } |
    Select-Object -First 1

if ($existingGhidra) {
    Write-Host "  Found: $($existingGhidra.FullName)" -ForegroundColor Yellow
    Write-Host "  Removing existing installation..." -ForegroundColor Gray
    Remove-Item -Path $existingGhidra.FullName -Recurse -Force -ErrorAction SilentlyContinue
    Write-Host "  Removed" -ForegroundColor Green
}

# ===================== Phase 1: Create directories =====================
Write-Host "`n[SETUP] Creating directories..." -ForegroundColor Cyan
@($toolsDir, $downloadDir, $ghidraScriptsDir) | ForEach-Object {
    New-Item -Path $_ -ItemType Directory -Force | Out-Null
}
Write-Host "  Done" -ForegroundColor Green

# ===================== Phase 2: Parallel Downloads =====================
$downloads = @(
    @{ 
        Name = "JDK 25"; 
        Url = $javaUrl; 
        Path = "$downloadDir\jdk-25_windows-x64_bin.exe";
        Type = "java"
    }
    @{ 
        Name = "Ghidra 12.0.2"; 
        Url = $ghidraUrl; 
        Path = "$downloadDir\ghidra.zip";
        Type = "ghidra"
    }
    @{ 
        Name = "Malware Function ReConer"; 
        Url = $scriptUrls[0]; 
        Path = "$ghidraScriptsDir\Malware_Function_ReConer_v3.py";
        Type = "script"
    }
    @{ 
        Name = "Anti-techniques Detection"; 
        Url = $scriptUrls[1]; 
        Path = "$ghidraScriptsDir\anti-techniques_detection.py";
        Type = "script"
    }
)

Write-Host "`n[DOWNLOAD] Starting parallel downloads (4 files)..." -ForegroundColor Cyan
Write-Host "  [1] JDK 25 (~180 MB)" -ForegroundColor Gray
Write-Host "  [2] Ghidra 12.0.2 (~300 MB)" -ForegroundColor Gray
Write-Host "  [3] Ghidra scripts (~100 KB)" -ForegroundColor Gray
Write-Host ""

# Start all download jobs
$jobs = @()
foreach ($dl in $downloads) {
    $jobs += Start-Job -Name $dl.Name -ScriptBlock {
        param($url, $path)
        try {
            $webClient = New-Object System.Net.WebClient
            $webClient.DownloadFile($url, $path)
            [PSCustomObject]@{
                Status = "OK"
                SizeMB = [math]::Round((Get-Item $path -ErrorAction SilentlyContinue).Length / 1MB, 2)
            }
        } catch {
            [PSCustomObject]@{ Status = "FAILED"; SizeMB = 0 }
        }
    } -ArgumentList $dl.Url, $dl.Path
}

# Progress monitoring
$totalFiles = $downloads.Count
$completedCount = 0

while (($jobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
    $completed = ($jobs | Where-Object { $_.State -eq 'Completed' }).Count
    if ($completed -gt $completedCount) {
        $completedCount = $completed
        Write-Host "  Downloaded: $completed/$totalFiles files" -NoNewline -ForegroundColor Yellow
        Write-Host "   " -NoNewline
    }
    
    # Show download speeds (simplified)
    Start-Sleep -Milliseconds 500
}

Write-Host "`r  Downloaded: $totalFiles/$totalFiles files" -ForegroundColor Green
Write-Host ""

# Show results
$successCount = 0
foreach ($job in $jobs) {
    $result = Receive-Job -Job $job -Wait -AutoRemoveJob
    if ($result.Status -eq "OK") {
        Write-Host "  [OK] $($job.Name)" -NoNewline -ForegroundColor Green
        if ($result.SizeMB -gt 0) {
            Write-Host " ($($result.SizeMB) MB)" -ForegroundColor Gray
        } else {
            Write-Host ""
        }
        $successCount++
    } else {
        Write-Host "  [FAIL] $($job.Name)" -ForegroundColor Red
    }
}

if ($successCount -lt $totalFiles) {
    Write-Host "`n  WARNING: Some downloads failed. Continuing with available files..." -ForegroundColor Yellow
}

# ===================== Phase 3: Parallel Install & Extract =====================
Write-Host "`n[INSTALL] Parallel installation..." -ForegroundColor Cyan

# Start Java installation (silent)
$javaInstaller = "$downloadDir\jdk-25_windows-x64_bin.exe"
$ghidraZip = "$downloadDir\ghidra.zip"

$installJobs = @()

# Job 1: Install Java
if (Test-Path $javaInstaller) {
    $installJobs += Start-Job -Name "Java Install" -ScriptBlock {
        param($installer)
        Start-Process -FilePath $installer -ArgumentList "/s" -Wait -NoNewWindow
    } -ArgumentList $javaInstaller
    Write-Host "  [1] Java JDK 25 (silent install)" -ForegroundColor Gray
}

# Job 2: Extract Ghidra
if (Test-Path $ghidraZip) {
    $installJobs += Start-Job -Name "Ghidra Extract" -ScriptBlock {
        param($zip, $dest)
        Expand-Archive -LiteralPath $zip -DestinationPath $dest -Force
    } -ArgumentList $ghidraZip, $toolsDir
    Write-Host "  [2] Ghidra extraction" -ForegroundColor Gray
}

# Wait for both to complete
if ($installJobs.Count -gt 0) {
    $totalJobs = $installJobs.Count
    
    while (($installJobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
        $done = ($installJobs | Where-Object { $_.State -eq 'Completed' }).Count
        Write-Host "`r  Progress: $done/$totalJobs tasks" -NoNewline -ForegroundColor Yellow
        Start-Sleep -Milliseconds 300
    }
    
    Write-Host "`r  Progress: $totalJobs/$totalJobs tasks" -ForegroundColor Green
    Write-Host ""
    
    $installJobs | Receive-Job -Wait -AutoRemoveJob | Out-Null
}

# ===================== Phase 4: Post-install Setup =====================
Write-Host "`n[CONFIG] Final configuration..." -ForegroundColor Cyan

# Find Ghidra directory
$ghidraBaseDir = Get-ChildItem -Path $toolsDir -Directory |
    Where-Object { $_.Name -like "ghidra*_PUBLIC*" } |
    Select-Object -First 1

if ($ghidraBaseDir) {
    Write-Host "  Found: $($ghidraBaseDir.Name)" -ForegroundColor Green
    
    # Find scripts directory
    $possiblePaths = @(
        "Ghidra\Features\Base\ghidra_scripts",
        "ghidra_scripts"
    )
    
    $finalScriptsDir = $null
    foreach ($subPath in $possiblePaths) {
        $testPath = Join-Path $ghidraBaseDir.FullName $subPath
        if (Test-Path $testPath) {
            $finalScriptsDir = $testPath
            break
        }
    }
    
    # Create if not found
    if (-not $finalScriptsDir) {
        $finalScriptsDir = Join-Path $ghidraBaseDir.FullName "ghidra_scripts"
        New-Item -Path $finalScriptsDir -ItemType Directory -Force | Out-Null
    }
    
    # Copy scripts
    $scriptFiles = Get-ChildItem -Path $ghidraScriptsDir -Filter "*.py" -ErrorAction SilentlyContinue
    if ($scriptFiles) {
        foreach ($script in $scriptFiles) {
            Copy-Item -Path $script.FullName -Destination $finalScriptsDir -Force
        }
        Write-Host "  Scripts installed: $($scriptFiles.Count)" -ForegroundColor Green
    }
    
    # SKIPPED: PATH addition (as requested)
    # SKIPPED: Desktop shortcut creation (as requested)
} else {
    Write-Host "  WARNING: Ghidra directory not found!" -ForegroundColor Yellow
}

# ===================== Phase 5: Cleanup =====================
Write-Host "`n[CLEANUP] Removing temporary files..." -ForegroundColor Cyan
Remove-Item $downloadDir -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item $ghidraScriptsDir -Recurse -Force -ErrorAction SilentlyContinue
Write-Host "  Done" -ForegroundColor Green

# ===================== Summary =====================
$timer.Stop()
$elapsed = [math]::Round($timer.Elapsed.TotalSeconds, 1)

Write-Host ""
Write-Host "=============================================" -ForegroundColor Green
Write-Host "    INSTALLATION COMPLETE!" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host ""
Write-Host "  Total time: $elapsed seconds" -ForegroundColor Cyan
Write-Host ""
if ($ghidraBaseDir) {
    Write-Host "  Ghidra location:" -ForegroundColor White
    Write-Host "    $($ghidraBaseDir.FullName)" -ForegroundColor Gray
    Write-Host ""
    Write-Host "  Launch with:" -ForegroundColor White
    Write-Host "    $($ghidraBaseDir.FullName)\ghidraRun.bat" -ForegroundColor Yellow
}
Write-Host "=============================================" -ForegroundColor Green
