# ===================== Setup =====================
# Define tools directory
$toolsDir = "C:\Tools"
New-Item -Path $toolsDir -ItemType Directory -Force | Out-Null
# =====================================================================
# OPTIMIZED: Misc Tools 2 (7-Zip, Sysinternals, SystemInformer, FakeNet)
# - Parallel downloads using WebClient
# - Parallel extractions using 7-Zip
# =====================================================================

$ErrorActionPreference = "SilentlyContinue"

# ===================== Configuration =====================
$toolsDir = "C:\Tools"
$sevenZipDir = "C:\Program Files\7-Zip"
$sevenZipExe = "$sevenZipDir\7z.exe"

# ===================== Helper Functions =====================
function Start-ParallelDownloads {
    param([hashtable[]]$Downloads)
    
    Write-Host "`n[DOWNLOAD] Starting $($Downloads.Count) parallel downloads..." -ForegroundColor Cyan
    
    $jobs = @()
    foreach ($dl in $Downloads) {
        $jobs += Start-Job -ScriptBlock {
            param($url, $path)
            try {
                $webClient = New-Object System.Net.WebClient
                $webClient.DownloadFile($url, $path)
                return @{ Success = $true; Path = $path }
            } catch {
                return @{ Success = $false; Path = $path; Error = $_.Exception.Message }
            }
        } -ArgumentList $dl.Url, $dl.Path
        Write-Host "  Started: $($dl.Name)" -ForegroundColor Gray
    }
    
    while (($jobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
        $completed = ($jobs | Where-Object { $_.State -eq 'Completed' }).Count
        Write-Host "`r  Progress: $completed/$($jobs.Count) complete    " -NoNewline -ForegroundColor Yellow
        Start-Sleep -Milliseconds 300
    }
    Write-Host ""
    
    $results = $jobs | Receive-Job -Wait
    $jobs | Remove-Job -Force
    
    foreach ($result in $results) {
        if ($result.Success) {
            Write-Host "  OK: $(Split-Path $result.Path -Leaf)" -ForegroundColor Green
        } else {
            Write-Host "  FAILED: $(Split-Path $result.Path -Leaf)" -ForegroundColor Red
        }
    }
}

# ===================== Main Script =====================
$timer = [System.Diagnostics.Stopwatch]::StartNew()

Write-Host "=============================================" -ForegroundColor Cyan
Write-Host " Misc Tools 2 Installer (Optimized)" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan

# Create tools directory
New-Item -Path $toolsDir -ItemType Directory -Force | Out-Null

# ===================== Phase 1: Install 7-Zip if needed =====================
if (-not (Test-Path $sevenZipExe)) {
    Write-Host "`n[7-ZIP] Installing 7-Zip..." -ForegroundColor Cyan
    $sevenZipInstaller = "$env:TEMP\7zip.exe"
    (New-Object System.Net.WebClient).DownloadFile("https://www.7-zip.org/a/7z2301-x64.exe", $sevenZipInstaller)
    Start-Process -FilePath $sevenZipInstaller -ArgumentList "/S" -Wait
    Remove-Item $sevenZipInstaller -Force
    Write-Host "  7-Zip installed!" -ForegroundColor Green
} else {
    Write-Host "`n[7-ZIP] Already installed" -ForegroundColor Green
}

# ===================== Phase 2: Parallel Downloads =====================
$downloads = @(
    @{ Name = "SystemInformer"; Url = "https://github.com/winsiderss/systeminformer/releases/download/v3.2.25011.2103/systeminformer-3.2.25011-release-bin.zip"; Path = "$env:TEMP\systeminformer.zip" }
    @{ Name = "ProcessExplorer"; Url = "https://download.sysinternals.com/files/ProcessExplorer.zip"; Path = "$env:TEMP\ProcessExplorer.zip" }
    @{ Name = "Autoruns"; Url = "https://download.sysinternals.com/files/Autoruns.zip"; Path = "$env:TEMP\Autoruns.zip" }
    @{ Name = "ProcessMonitor"; Url = "https://download.sysinternals.com/files/ProcessMonitor.zip"; Path = "$env:TEMP\Procmon.zip" }
    @{ Name = "FakeNet-NG"; Url = "https://github.com/mandiant/flare-fakenet-ng/releases/download/v3.5/fakenet3.5.zip"; Path = "$env:TEMP\fakenet.zip" }
)

Start-ParallelDownloads -Downloads $downloads

# ===================== Phase 3: Parallel Extractions with 7-Zip =====================
Write-Host "`n[EXTRACT] Starting parallel extractions with 7-Zip..." -ForegroundColor Cyan

$extractions = @(
    @{ Zip = "$env:TEMP\systeminformer.zip"; Dest = "$toolsDir\SystemInformer" }
    @{ Zip = "$env:TEMP\ProcessExplorer.zip"; Dest = "$toolsDir\ProcessExplorer" }
    @{ Zip = "$env:TEMP\Autoruns.zip"; Dest = "$toolsDir\Autoruns" }
    @{ Zip = "$env:TEMP\Procmon.zip"; Dest = "$toolsDir\Procmon" }
    @{ Zip = "$env:TEMP\fakenet.zip"; Dest = "$toolsDir\FakeNet-NG" }
)

$extractJobs = @()
foreach ($ext in $extractions) {
    # Create destination directory
    New-Item -Path $ext.Dest -ItemType Directory -Force | Out-Null
    
    $extractJobs += Start-Job -ScriptBlock {
        param($sevenZip, $zip, $dest)
        & $sevenZip x $zip -o"$dest" -y 2>&1 | Out-Null
        return @{ Success = $true; Dest = $dest }
    } -ArgumentList $sevenZipExe, $ext.Zip, $ext.Dest
    
    Write-Host "  Started: $(Split-Path $ext.Dest -Leaf)" -ForegroundColor Gray
}

# Wait for extractions
while (($extractJobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
    $completed = ($extractJobs | Where-Object { $_.State -eq 'Completed' }).Count
    Write-Host "`r  Progress: $completed/$($extractJobs.Count) complete    " -NoNewline -ForegroundColor Yellow
    Start-Sleep -Milliseconds 300
}
Write-Host ""

$extractJobs | Receive-Job -Wait | Out-Null
$extractJobs | Remove-Job -Force

Write-Host "  All extractions complete!" -ForegroundColor Green

# ===================== Phase 4: Cleanup =====================
Write-Host "`n[CLEANUP] Removing temporary files..." -ForegroundColor Cyan
$downloads | ForEach-Object { Remove-Item $_.Path -Force -ErrorAction SilentlyContinue }

# ===================== Summary =====================
$timer.Stop()

Write-Host "`n=============================================" -ForegroundColor Green
Write-Host " Complete! Time: $([math]::Round($timer.Elapsed.TotalSeconds, 1))s" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host "  Tools installed to: $toolsDir"
Write-Host "  - SystemInformer"
Write-Host "  - ProcessExplorer"
Write-Host "  - Autoruns"
Write-Host "  - Procmon"
Write-Host "  - FakeNet-NG"

# ===================== 7-Zip Install =====================
$sevenZipDir = "C:\Program Files\7-Zip"
$sevenZipExe = Join-Path $sevenZipDir "7z.exe"

if (-Not (Test-Path $sevenZipExe)) {
    Write-Host "`nInstalling 7-Zip..."
    $sevenZipInstaller = "$env:TEMP\7zip.exe"
    Invoke-WebRequest -Uri "https://www.7-zip.org/a/7z2301-x64.exe" -OutFile $sevenZipInstaller
    Start-Process -FilePath $sevenZipInstaller -ArgumentList "/S" -Wait
    Remove-Item $sevenZipInstaller
} else {
    Write-Host "7-Zip is already installed."
}

# Function to extract using 7-Zip
function Extract-With7Zip {
    param (
        [string]$zipPath,
        [string]$extractTo
    )

    if (-Not (Test-Path $extractTo)) {
        New-Item -Path $extractTo -ItemType Directory -Force | Out-Null
    }

    & "$sevenZipExe" x "$zipPath" -o"$extractTo" -y | Out-Null
}

# ===================== System Informer (ZIP) =====================
$sysInformerZip = "$env:TEMP\systeminformer.zip"
$sysInformerUrl = "https://github.com/winsiderss/systeminformer/releases/download/v3.2.25011.2103/systeminformer-3.2.25011-release-bin.zip"

Invoke-WebRequest -Uri $sysInformerUrl -OutFile $sysInformerZip
Extract-With7Zip -zipPath $sysInformerZip -extractTo "$toolsDir\SystemInformer"
Remove-Item $sysInformerZip

# ===================== Sysinternals Tools =====================
$sysinternals = @(
    @{ name = "ProcessExplorer"; url = "https://download.sysinternals.com/files/ProcessExplorer.zip"; dest = "$toolsDir\ProcessExplorer" },
    @{ name = "Autoruns";         url = "https://download.sysinternals.com/files/Autoruns.zip";         dest = "$toolsDir\Autoruns" },
    @{ name = "Procmon";          url = "https://download.sysinternals.com/files/ProcessMonitor.zip";   dest = "$toolsDir\Procmon" }
)

foreach ($tool in $sysinternals) {
    $zipPath = "$env:TEMP\$($tool.name).zip"
    Invoke-WebRequest -Uri $tool.url -OutFile $zipPath
    Extract-With7Zip -zipPath $zipPath -extractTo $tool.dest
    Remove-Item $zipPath
}



# ===================== FakeNet-NG =====================
$fakenetZip = "$env:TEMP\fakenet.zip"
$fakenetUrl = "https://github.com/mandiant/flare-fakenet-ng/releases/download/v3.5/fakenet3.5.zip"
Invoke-WebRequest -Uri $fakenetUrl -OutFile $fakenetZip
Extract-With7Zip -zipPath $fakenetZip -extractTo "$toolsDir\FakeNet-NG"
Remove-Item $fakenetZip



Write-Host "`n? All tools installed or extracted in C:\Tools"
