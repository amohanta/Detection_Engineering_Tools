# =====================================================================
# OPTIMIZED: Misc Tools Download Script
# - Parallel downloads using WebClient
# - Simple progress display
# - Parallel extractions
# =====================================================================

$ErrorActionPreference = "SilentlyContinue"

# ===================== Configuration =====================
$toolsDir = "C:\tools"
$tridDir = "$toolsDir\trid"
$openArkDir = "$toolsDir\OpenARK"
$memoryDumperDir = "$toolsDir\memory-dumper"

# ===================== Helper Functions =====================
function Convert-GitHubToRaw {
    param([string]$Url)
    return $Url -replace "github\.com", "raw.githubusercontent.com" -replace "/blob/", "/"
}

# ===================== Main Script =====================
$timer = [System.Diagnostics.Stopwatch]::StartNew()

Write-Host ""
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "    MISC TOOLS INSTALLER (Optimized)" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan

# Create all directories upfront
Write-Host "`n[SETUP] Creating directories..." -ForegroundColor Cyan
@($toolsDir, $tridDir, $openArkDir, $memoryDumperDir) | ForEach-Object {
    New-Item -Path $_ -ItemType Directory -Force | Out-Null
}
Write-Host "  Done" -ForegroundColor Green

# ===================== Phase 1: Parallel Downloads =====================
$downloads = @(
    @{ Name = "bintext.exe"; Url = (Convert-GitHubToRaw "https://github.com/amohanta/Malware_Analysis_Tools-third_party/blob/main/bintext/bintext.exe"); Path = "$toolsDir\bintext.exe" }
    @{ Name = "COMView.exe"; Url = (Convert-GitHubToRaw "https://github.com/amohanta/Malware_Analysis_Tools-third_party/blob/main/COM-Object-View/COMView.exe"); Path = "$toolsDir\COMView.exe" }
    @{ Name = "trid.exe"; Url = (Convert-GitHubToRaw "https://github.com/angerangel/TrIDGUI2/blob/master/trid.exe"); Path = "$tridDir\trid.exe" }
    @{ Name = "triddefs.trd"; Url = (Convert-GitHubToRaw "https://github.com/angerangel/TrIDGUI2/blob/master/triddefs.trd"); Path = "$tridDir\triddefs.trd" }
    @{ Name = "pd64.exe"; Url = "https://raw.githubusercontent.com/amohanta/Malware_Analysis_Tools-third_party/refs/heads/main/memory_dumping/pd64.exe"; Path = "$memoryDumperDir\pd64.exe" }
    @{ Name = "pd32.exe"; Url = (Convert-GitHubToRaw "https://github.com/amohanta/Malware_Analysis_Tools-third_party/blob/main/memory_dumping/pd32.exe"); Path = "$memoryDumperDir\pd32.exe" }
    @{ Name = "deleteDllFilesFile.exe"; Url = (Convert-GitHubToRaw "https://github.com/amohanta/Malware_Analysis_Tools-third_party/blob/main/memory_dumping/deleteDllFilesFile.exe"); Path = "$memoryDumperDir\deleteDllFilesFile.exe" }
    @{ Name = "CryptoTester.zip"; Url = "https://github.com/Demonslay335/CryptoTester/releases/download/v1.7.2.0/CryptoTester.zip"; Path = "$env:TEMP\CryptoTester.zip" }
    @{ Name = "OpenArk.zip"; Url = "http://file.blackint3.com:88/openark/files/openark/OpenArk-v1.5.2/OpenArk-v1.5.2.zip"; Path = "$env:TEMP\OpenArk.zip" }
    @{ Name = "ExplorerSuite.exe"; Url = "https://ntcore.com/files/ExplorerSuite.exe"; Path = "$env:TEMP\ExplorerSuite.exe" }
)

Write-Host "`n[DOWNLOAD] Starting $($downloads.Count) parallel downloads..." -ForegroundColor Cyan

# Start all download jobs
$jobs = @()
foreach ($dl in $downloads) {
    $jobs += Start-Job -Name $dl.Name -ScriptBlock {
        param($url, $path)
        try {
            $webClient = New-Object System.Net.WebClient
            $webClient.DownloadFile($url, $path)
            return "OK"
        } catch {
            return "FAILED"
        }
    } -ArgumentList $dl.Url, $dl.Path
}

# Monitor progress
$totalFiles = $downloads.Count

while (($jobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
    $completed = ($jobs | Where-Object { $_.State -eq 'Completed' }).Count
    $running = $jobs | Where-Object { $_.State -eq 'Running' } | Select-Object -ExpandProperty Name
    
    # Progress bar
    $percent = [math]::Floor(($completed / $totalFiles) * 100)
    $barFilled = [math]::Floor($percent / 2.5)
    $barEmpty = 40 - $barFilled
    $bar = "[" + ("#" * $barFilled) + ("-" * $barEmpty) + "]"
    
    # Show current downloads (first 3)
    $activeList = ($running | Select-Object -First 3) -join ", "
    if ($running.Count -gt 3) { $activeList += "..." }
    
    Write-Host "`r  $bar $percent% | Downloading: $activeList                              " -NoNewline -ForegroundColor Yellow
    Start-Sleep -Milliseconds 300
}

Write-Host "`r  [########################################] 100% | All downloads complete!                    " -ForegroundColor Green
Write-Host ""

# Show results
$successCount = 0
$failCount = 0

foreach ($job in $jobs) {
    $result = Receive-Job -Job $job -Wait
    if ($result -eq "OK") {
        Write-Host "  [OK] $($job.Name)" -ForegroundColor Green
        $successCount++
    } else {
        Write-Host "  [FAIL] $($job.Name)" -ForegroundColor Red
        $failCount++
    }
}
$jobs | Remove-Job -Force

Write-Host ""
if ($failCount -eq 0) {
    Write-Host "  All $successCount files downloaded successfully!" -ForegroundColor Green
} else {
    Write-Host "  Downloaded: $successCount OK, $failCount failed" -ForegroundColor Yellow
}

# ===================== Phase 2: Parallel Extract + Install =====================
Write-Host "`n[INSTALL] Starting extractions and installer..." -ForegroundColor Cyan

# Start ExplorerSuite installer
Write-Host "  Starting: ExplorerSuite installer" -ForegroundColor Gray
$explorerJob = Start-Process -FilePath "$env:TEMP\ExplorerSuite.exe" -ArgumentList "/SILENT" -PassThru

# Start extractions in parallel
$extractJobs = @()

$extractJobs += Start-Job -Name "CryptoTester" -ScriptBlock {
    param($zip, $dest)
    Expand-Archive -LiteralPath $zip -DestinationPath $dest -Force
} -ArgumentList "$env:TEMP\CryptoTester.zip", $toolsDir

$extractJobs += Start-Job -Name "OpenArk" -ScriptBlock {
    param($zip, $dest)
    Expand-Archive -LiteralPath $zip -DestinationPath $dest -Force
} -ArgumentList "$env:TEMP\OpenArk.zip", $openArkDir

Write-Host "  Starting: CryptoTester extraction" -ForegroundColor Gray
Write-Host "  Starting: OpenArk extraction" -ForegroundColor Gray

# Wait for extractions
Write-Host "`n[WAIT] Waiting for completion..." -ForegroundColor Yellow

while (($extractJobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0 -or -not $explorerJob.HasExited) {
    $extDone = ($extractJobs | Where-Object { $_.State -eq 'Completed' }).Count
    $extTotal = $extractJobs.Count
    $instStatus = if ($explorerJob.HasExited) { "Done" } else { "Running" }
    
    Write-Host "`r  Extractions: $extDone/$extTotal | ExplorerSuite: $instStatus          " -NoNewline -ForegroundColor Yellow
    Start-Sleep -Milliseconds 300
}

Write-Host "`r  Extractions: $($extractJobs.Count)/$($extractJobs.Count) | ExplorerSuite: Done              " -ForegroundColor Green

$extractJobs | Receive-Job -Wait | Out-Null
$extractJobs | Remove-Job -Force

Write-Host ""
Write-Host "  [OK] CryptoTester extracted" -ForegroundColor Green
Write-Host "  [OK] OpenArk extracted" -ForegroundColor Green
Write-Host "  [OK] ExplorerSuite installed" -ForegroundColor Green

# ===================== Phase 3: Cleanup =====================
Write-Host "`n[CLEANUP] Removing temporary files..." -ForegroundColor Cyan
Remove-Item "$env:TEMP\CryptoTester.zip" -Force -ErrorAction SilentlyContinue
Remove-Item "$env:TEMP\OpenArk.zip" -Force -ErrorAction SilentlyContinue
Remove-Item "$env:TEMP\ExplorerSuite.exe" -Force -ErrorAction SilentlyContinue
Write-Host "  Done" -ForegroundColor Green

# ===================== Summary =====================
$timer.Stop()
$elapsed = [math]::Round($timer.Elapsed.TotalSeconds, 1)

Write-Host ""
Write-Host "=============================================" -ForegroundColor Green
Write-Host "    INSTALLATION COMPLETE!" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host ""
Write-Host "  Time: $elapsed seconds" -ForegroundColor Cyan
Write-Host ""
Write-Host "  Installed to:" -ForegroundColor White
Write-Host "    $toolsDir" -ForegroundColor Gray
Write-Host "    $tridDir" -ForegroundColor Gray
Write-Host "    $openArkDir" -ForegroundColor Gray
Write-Host "    $memoryDumperDir" -ForegroundColor Gray
Write-Host ""
