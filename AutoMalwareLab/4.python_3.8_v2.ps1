# =====================================================================
# HYPER-FAST Python 3.8 Installer (Parallel Download + Install)
# =====================================================================

$ErrorActionPreference = "SilentlyContinue"
$ProgressPreference = "SilentlyContinue"

# ===================== Configuration =====================
$toolsDir = "C:\tools"
$downloadDir = "$env:TEMP\python_downloads"

# URLs
$pythonX64Url = "https://www.python.org/ftp/python/3.8.0/python-3.8.0-amd64.exe"
$pythonX86Url = "https://www.python.org/ftp/python/3.8.0/python-3.8.0.exe"

# Local paths
$pythonX64Installer = "$downloadDir\python-3.8.0-amd64.exe"
$pythonX86Installer = "$downloadDir\python-3.8.0.exe"

# Installation directories
$installDirX64 = "C:\python-3.8-x64"
$installDirX86 = "C:\python-3.8-x86"

# ===================== Main Script =====================
$timer = [System.Diagnostics.Stopwatch]::StartNew()

Write-Host ""
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "    HYPER-FAST PYTHON 3.8 INSTALLER" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "    • Parallel downloads" -ForegroundColor Gray
Write-Host "    • Silent installations" -ForegroundColor Gray
Write-Host "    • Clean directory structure" -ForegroundColor Gray
Write-Host "=============================================" -ForegroundColor Cyan

# ===================== Phase 1: Setup =====================
Write-Host "`n[SETUP] Preparing system..." -ForegroundColor Cyan

# Clean existing installations
@($installDirX64, $installDirX86, $downloadDir) | ForEach-Object {
    if (Test-Path $_) {
        Write-Host "  Removing: $_" -ForegroundColor Yellow
        Remove-Item -Path $_ -Recurse -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 1
    }
}

# Create directories
@($toolsDir, $downloadDir) | ForEach-Object {
    New-Item -Path $_ -ItemType Directory -Force | Out-Null
}

Write-Host "  Directories created" -ForegroundColor Green

# ===================== Phase 2: Parallel Downloads =====================
$downloads = @(
    @{ 
        Name = "Python 3.8 x64"; 
        Url = $pythonX64Url; 
        Path = $pythonX64Installer;
        Size = "~25 MB"
    }
    @{ 
        Name = "Python 3.8 x86"; 
        Url = $pythonX86Url; 
        Path = $pythonX86Installer;
        Size = "~25 MB"
    }
)

Write-Host "`n[DOWNLOAD] Starting parallel downloads..." -ForegroundColor Cyan
Write-Host "  [1] Python 3.8 x64 (~25 MB)" -ForegroundColor Gray
Write-Host "  [2] Python 3.8 x86 (~25 MB)" -ForegroundColor Gray
Write-Host ""

# Start all download jobs
$jobs = @()
foreach ($dl in $downloads) {
    $jobs += Start-Job -Name $dl.Name -ScriptBlock {
        param($url, $path)
        try {
            $webClient = New-Object System.Net.WebClient
            $webClient.DownloadFile($url, $path)
            [PSCustomObject]@{
                Status = "OK"
                SizeMB = [math]::Round((Get-Item $path -ErrorAction SilentlyContinue).Length / 1MB, 2)
            }
        } catch {
            [PSCustomObject]@{ Status = "FAILED"; SizeMB = 0 }
        }
    } -ArgumentList $dl.Url, $dl.Path
}

# Progress monitoring
$totalFiles = $downloads.Count
$completedCount = 0

while (($jobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
    $completed = ($jobs | Where-Object { $_.State -eq 'Completed' }).Count
    if ($completed -gt $completedCount) {
        $completedCount = $completed
        Write-Host "  Downloaded: $completed/$totalFiles files" -NoNewline -ForegroundColor Yellow
        Write-Host "   " -NoNewline
    }
    Start-Sleep -Milliseconds 500
}

Write-Host "`r  Downloaded: $totalFiles/$totalFiles files" -ForegroundColor Green
Write-Host ""

# Show results
$successCount = 0
foreach ($job in $jobs) {
    $result = Receive-Job -Job $job -Wait -AutoRemoveJob
    if ($result.Status -eq "OK") {
        Write-Host "  [OK] $($job.Name)" -NoNewline -ForegroundColor Green
        if ($result.SizeMB -gt 0) {
            Write-Host " ($($result.SizeMB) MB)" -ForegroundColor Gray
        } else {
            Write-Host ""
        }
        $successCount++
    } else {
        Write-Host "  [FAIL] $($job.Name)" -ForegroundColor Red
    }
}

if ($successCount -lt $totalFiles) {
    Write-Host "`n  WARNING: Some downloads failed!" -ForegroundColor Yellow
    exit 1
}

# ===================== Phase 3: Parallel Installations =====================
Write-Host "`n[INSTALL] Starting parallel installations..." -ForegroundColor Cyan

$installJobs = @()

# Job 1: Install Python x64
$installJobs += Start-Job -Name "Python x64" -ScriptBlock {
    param($installer, $targetDir)
    
    # Create target directory
    New-Item -Path $targetDir -ItemType Directory -Force | Out-Null
    
    # Silent install arguments
    $args = @(
        "/quiet",                # Silent mode
        "InstallAllUsers=0",     # Per-user install (respects TargetDir better)
        "TargetDir=$targetDir",  # Custom installation directory
        "DefaultJustForMeTargetDir=$targetDir",
        "AssociateFiles=0",      # Don't associate .py files
        "CompileAll=0",          # Don't compile all .py files to .pyc
        "PrependPath=0",         # Don't add to PATH (we'll do this manually)
        "Include_doc=0",         # Don't install documentation
        "Include_test=0",        # Don't install test suite
        "Include_launcher=0",    # Don't install Python launcher
        "Shortcuts=0"            # Don't create shortcuts
    )
    
    try {
        $process = Start-Process -FilePath $installer -ArgumentList $args -Wait -PassThru -NoNewWindow
        
        # Verify installation
        Start-Sleep -Seconds 3
        if (Test-Path "$targetDir\python.exe") {
            return "OK"
        } else {
            return "FAILED"
        }
    } catch {
        return "FAILED"
    }
} -ArgumentList $pythonX64Installer, $installDirX64

Write-Host "  [1] Installing Python 3.8 x64 to: $installDirX64" -ForegroundColor Gray

# Job 2: Install Python x86
$installJobs += Start-Job -Name "Python x86" -ScriptBlock {
    param($installer, $targetDir)
    
    # Create target directory
    New-Item -Path $targetDir -ItemType Directory -Force | Out-Null
    
    # Silent install arguments
    $args = @(
        "/quiet",
        "InstallAllUsers=0",
        "TargetDir=$targetDir",
        "DefaultJustForMeTargetDir=$targetDir",
        "AssociateFiles=0",
        "CompileAll=0",
        "PrependPath=0",
        "Include_doc=0",
        "Include_test=0",
        "Include_launcher=0",
        "Shortcuts=0"
    )
    
    try {
        $process = Start-Process -FilePath $installer -ArgumentList $args -Wait -PassThru -NoNewWindow
        
        # Verify installation
        Start-Sleep -Seconds 3
        if (Test-Path "$targetDir\python.exe") {
            return "OK"
        } else {
            return "FAILED"
        }
    } catch {
        return "FAILED"
    }
} -ArgumentList $pythonX86Installer, $installDirX86

Write-Host "  [2] Installing Python 3.8 x86 to: $installDirX86" -ForegroundColor Gray
Write-Host ""

# Monitor installation progress
$totalJobs = $installJobs.Count
$installSuccess = 0

while (($installJobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
    $done = ($installJobs | Where-Object { $_.State -eq 'Completed' }).Count
    Write-Host "`r  Installation progress: $done/$totalJobs" -NoNewline -ForegroundColor Yellow
    Start-Sleep -Milliseconds 500
}

Write-Host "`r  Installation progress: $totalJobs/$totalJobs" -ForegroundColor Green
Write-Host ""

# Check results
foreach ($job in $installJobs) {
    $result = Receive-Job -Job $job -Wait -AutoRemoveJob
    if ($result -eq "OK") {
        Write-Host "  [OK] $($job.Name) installed successfully" -ForegroundColor Green
        $installSuccess++
        
        # Verify version
        if ($job.Name -eq "Python x64") {
            $version = & "$installDirX64\python.exe" --version 2>&1
            Write-Host "       Version: $version" -ForegroundColor Gray
        } else {
            $version = & "$installDirX86\python.exe" --version 2>&1
            Write-Host "       Version: $version" -ForegroundColor Gray
        }
    } else {
        Write-Host "  [FAIL] $($job.Name) installation failed" -ForegroundColor Red
    }
}

# ===================== Phase 4: Update PATH =====================
Write-Host "`n[CONFIG] Updating system PATH..." -ForegroundColor Cyan

if ($installSuccess -eq 2) {
    $pathsToAdd = @(
        $installDirX64,
        "$installDirX64\Scripts",
        $installDirX86,
        "$installDirX86\Scripts"
    )
    
    $currentPath = [Environment]::GetEnvironmentVariable("Path", [EnvironmentVariableTarget]::Machine)
    $pathsAdded = @()
    
    foreach ($p in $pathsToAdd) {
        if (Test-Path $p) {
            if ($currentPath -notlike "*$p*") {
                $currentPath = "$currentPath;$p"
                $pathsAdded += $p
                Write-Host "  Added: $p" -ForegroundColor Green
            } else {
                Write-Host "  Already in PATH: $p" -ForegroundColor Gray
            }
        }
    }
    
    if ($pathsAdded.Count -gt 0) {
        [Environment]::SetEnvironmentVariable("Path", $currentPath, [EnvironmentVariableTarget]::Machine)
        Write-Host "  System PATH updated" -ForegroundColor Green
    }
    
    # Update current session PATH
    $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
}

# ===================== Phase 5: Cleanup =====================
Write-Host "`n[CLEANUP] Removing temporary files..." -ForegroundColor Cyan
Remove-Item $downloadDir -Recurse -Force -ErrorAction SilentlyContinue
Write-Host "  Done" -ForegroundColor Green

# ===================== Summary =====================
$timer.Stop()
$elapsed = [math]::Round($timer.Elapsed.TotalSeconds, 1)

Write-Host ""
Write-Host "=============================================" -ForegroundColor Green
Write-Host "    INSTALLATION COMPLETE!" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host ""
Write-Host "  Total time: $elapsed seconds" -ForegroundColor Cyan
Write-Host ""
Write-Host "  Python installations:" -ForegroundColor White
Write-Host "    x64: $installDirX64" -ForegroundColor Gray
Write-Host "    x86: $installDirX86" -ForegroundColor Gray
Write-Host ""
Write-Host "  Test installation:" -ForegroundColor White
if (Test-Path "$installDirX64\python.exe") {
    Write-Host "    x64: & '$installDirX64\python.exe' --version" -ForegroundColor Yellow
}
if (Test-Path "$installDirX86\python.exe") {
    Write-Host "    x86: & '$installDirX86\python.exe' --version" -ForegroundColor Yellow
}
Write-Host "=============================================" -ForegroundColor Green
