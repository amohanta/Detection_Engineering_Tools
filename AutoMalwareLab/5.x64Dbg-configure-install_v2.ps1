# =====================================================================
# OPTIMIZED Python 3.8 + x64dbg Installation Script
# - Parallel downloads using WebClient (faster than Invoke-WebRequest)
# - Parallel installations
# - Single PATH registry write
# - Parallel extraction
# =====================================================================

#Requires -RunAsAdministrator

$ErrorActionPreference = "Stop"

# ===================== Configuration =====================
# Python
$pythonX64Url = "https://www.python.org/ftp/python/3.8.0/python-3.8.0-amd64.exe"
$pythonX86Url = "https://www.python.org/ftp/python/3.8.0/python-3.8.0.exe"
$pythonX64Installer = "$env:TEMP\python-3.8.0-amd64.exe"
$pythonX86Installer = "$env:TEMP\python-3.8.0.exe"
$installDirX64 = "C:\python-3.8-x64"
$installDirX86 = "C:\python-3.8-x86"

# x64dbg
$snapshotUrl = "https://excellmedia.dl.sourceforge.net/project/x64dbg/snapshots/snapshot_2025-03-15_15-57.zip?viasf=1"
$pluginUrl = "https://raw.githubusercontent.com/amohanta/Malware_Analysis_Tools-third_party/refs/heads/main/x64Dbg-Plugins/x64Dbg-all-plugins_v2.zip"
$baseDir = "C:\tools"
$snapshotZip = "$env:TEMP\x64dbg_snapshot.zip"
$pluginZip = "$env:TEMP\x64dbg_plugins.zip"
$snapshotExtractDir = "$baseDir\x64dbg"
$pluginExtractDir = "$env:TEMP\x64dbg_plugins"

# ===================== Helper Functions =====================

# Fast parallel download using .NET WebClient with jobs
function Start-ParallelDownloads {
    param(
        [hashtable[]]$Downloads  # Array of @{Url="..."; Path="..."; Name="..."}
    )
    
    Write-Host "`n[DOWNLOAD] Starting $($Downloads.Count) parallel downloads..." -ForegroundColor Cyan
    
    $jobs = @()
    foreach ($dl in $Downloads) {
        $jobs += Start-Job -ScriptBlock {
            param($url, $path)
            try {
                $webClient = New-Object System.Net.WebClient
                $webClient.DownloadFile($url, $path)
                return @{ Success = $true; Path = $path }
            } catch {
                return @{ Success = $false; Path = $path; Error = $_.Exception.Message }
            }
        } -ArgumentList $dl.Url, $dl.Path
        
        Write-Host "  Started: $($dl.Name)" -ForegroundColor Gray
    }
    
    # Wait for all downloads with progress
    $completed = 0
    while ($completed -lt $jobs.Count) {
        $completed = ($jobs | Where-Object { $_.State -eq 'Completed' }).Count
        $running = $jobs.Count - $completed
        Write-Host "`r  Progress: $completed/$($jobs.Count) complete, $running running...    " -NoNewline -ForegroundColor Yellow
        Start-Sleep -Milliseconds 500
    }
    Write-Host ""
    
    # Collect results
    $results = $jobs | Receive-Job -Wait
    $jobs | Remove-Job -Force
    
    $allSuccess = $true
    foreach ($result in $results) {
        if ($result.Success) {
            Write-Host "  OK: $($result.Path)" -ForegroundColor Green
        } else {
            Write-Host "  FAILED: $($result.Path) - $($result.Error)" -ForegroundColor Red
            $allSuccess = $false
        }
    }
    
    return $allSuccess
}

# Batch PATH update (single registry write)
function Add-PathsBatch {
    param([string[]]$Paths)
    
    $currentPath = [Environment]::GetEnvironmentVariable("Path", [EnvironmentVariableTarget]::Machine)
    $pathsToAdd = @()
    
    foreach ($p in $Paths) {
        if ((Test-Path $p) -and ($currentPath -notlike "*$p*")) {
            $pathsToAdd += $p
        }
    }
    
    if ($pathsToAdd.Count -gt 0) {
        $newPathValue = "$currentPath;$($pathsToAdd -join ';')"
        [Environment]::SetEnvironmentVariable("Path", $newPathValue, [EnvironmentVariableTarget]::Machine)
        Write-Host "  Added $($pathsToAdd.Count) paths to system PATH" -ForegroundColor Green
        return $true
    }
    return $false
}

# Create directories in batch
function New-DirectoriesBatch {
    param([string[]]$Dirs)
    foreach ($dir in $Dirs) {
        if (-not (Test-Path $dir)) {
            New-Item -Path $dir -ItemType Directory -Force | Out-Null
        }
    }
}

# ===================== Main Script =====================

$totalTimer = [System.Diagnostics.Stopwatch]::StartNew()

Write-Host "=============================================" -ForegroundColor Cyan
Write-Host " Python 3.8 + x64dbg Optimized Installer" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan

# Create all directories upfront
Write-Host "`n[SETUP] Creating directories..." -ForegroundColor Cyan
New-DirectoriesBatch @($baseDir, $snapshotExtractDir, $pluginExtractDir)

# ===================== PHASE 1: Parallel Downloads =====================
$downloads = @(
    @{ Url = $pythonX64Url; Path = $pythonX64Installer; Name = "Python 3.8 x64" }
    @{ Url = $pythonX86Url; Path = $pythonX86Installer; Name = "Python 3.8 x86" }
    @{ Url = $snapshotUrl; Path = $snapshotZip; Name = "x64dbg snapshot" }
    @{ Url = $pluginUrl; Path = $pluginZip; Name = "x64dbg plugins" }
)

$downloadSuccess = Start-ParallelDownloads -Downloads $downloads

if (-not $downloadSuccess) {
    Write-Host "`nSome downloads failed! Aborting." -ForegroundColor Red
    exit 1
}

# ===================== PHASE 2: Parallel Install + Extract =====================
Write-Host "`n[INSTALL] Starting parallel installations and extractions..." -ForegroundColor Cyan

# Start Python installations (parallel)
$pythonX64Job = Start-Process -FilePath $pythonX64Installer -ArgumentList "/quiet InstallAllUsers=0 TargetDir=$installDirX64 DefaultJustForMeTargetDir=$installDirX64 Include_test=0 Include_doc=0 Include_launcher=0 PrependPath=0" -PassThru
$pythonX86Job = Start-Process -FilePath $pythonX86Installer -ArgumentList "/quiet InstallAllUsers=0 TargetDir=$installDirX86 DefaultJustForMeTargetDir=$installDirX86 Include_test=0 Include_doc=0 Include_launcher=0 PrependPath=0" -PassThru

Write-Host "  Started: Python x64 installer (PID: $($pythonX64Job.Id))" -ForegroundColor Gray
Write-Host "  Started: Python x86 installer (PID: $($pythonX86Job.Id))" -ForegroundColor Gray

# Start ZIP extractions in parallel (using jobs)
$extractJob1 = Start-Job -ScriptBlock {
    param($zip, $dest)
    Expand-Archive -LiteralPath $zip -DestinationPath $dest -Force
} -ArgumentList $snapshotZip, $snapshotExtractDir

$extractJob2 = Start-Job -ScriptBlock {
    param($zip, $dest)
    Expand-Archive -LiteralPath $zip -DestinationPath $dest -Force
} -ArgumentList $pluginZip, $pluginExtractDir

Write-Host "  Started: x64dbg snapshot extraction" -ForegroundColor Gray
Write-Host "  Started: x64dbg plugins extraction" -ForegroundColor Gray

# Wait for all to complete
Write-Host "`n[WAIT] Waiting for installations and extractions..." -ForegroundColor Yellow

$allDone = $false
while (-not $allDone) {
    $pyX64Done = $pythonX64Job.HasExited
    $pyX86Done = $pythonX86Job.HasExited
    $ext1Done = $extractJob1.State -eq 'Completed'
    $ext2Done = $extractJob2.State -eq 'Completed'
    
    $status = @(
        "Py64:$(if($pyX64Done){'OK'}else{'...'})"
        "Py86:$(if($pyX86Done){'OK'}else{'...'})"
        "x64dbg:$(if($ext1Done){'OK'}else{'...'})"
        "Plugins:$(if($ext2Done){'OK'}else{'...'})"
    ) -join " | "
    
    Write-Host "`r  $status    " -NoNewline
    
    $allDone = $pyX64Done -and $pyX86Done -and $ext1Done -and $ext2Done
    if (-not $allDone) { Start-Sleep -Milliseconds 500 }
}
Write-Host ""

# Clean up jobs
$extractJob1, $extractJob2 | Receive-Job -Wait -ErrorAction SilentlyContinue | Out-Null
$extractJob1, $extractJob2 | Remove-Job -Force

Write-Host "  All installations and extractions complete!" -ForegroundColor Green

# ===================== PHASE 3: Python Verification & PATH =====================
Write-Host "`n[VERIFY] Checking Python installations..." -ForegroundColor Cyan

Start-Sleep -Seconds 2  # Brief wait for filesystem

$pythonPaths = @()

# Check x64
if (Test-Path "$installDirX64\python.exe") {
    $ver = & "$installDirX64\python.exe" --version 2>&1
    Write-Host "  x64: $ver at $installDirX64" -ForegroundColor Green
    $pythonPaths += $installDirX64
    $pythonPaths += "$installDirX64\Scripts"
} else {
    Write-Host "  x64: Not found at $installDirX64 - checking default locations..." -ForegroundColor Yellow
    $defaultX64 = "$env:LOCALAPPDATA\Programs\Python\Python38"
    if (Test-Path "$defaultX64\python.exe") {
        Write-Host "  x64: Found at $defaultX64, moving..." -ForegroundColor Yellow
        Move-Item -Path $defaultX64 -Destination $installDirX64 -Force -ErrorAction SilentlyContinue
        if (Test-Path "$installDirX64\python.exe") {
            $pythonPaths += $installDirX64
            $pythonPaths += "$installDirX64\Scripts"
            Write-Host "  x64: Moved to $installDirX64" -ForegroundColor Green
        }
    }
}

# Check x86
if (Test-Path "$installDirX86\python.exe") {
    $ver = & "$installDirX86\python.exe" --version 2>&1
    Write-Host "  x86: $ver at $installDirX86" -ForegroundColor Green
    $pythonPaths += $installDirX86
    $pythonPaths += "$installDirX86\Scripts"
} else {
    Write-Host "  x86: Not found at $installDirX86 - checking default locations..." -ForegroundColor Yellow
    $defaultX86 = "$env:LOCALAPPDATA\Programs\Python\Python38-32"
    if (Test-Path "$defaultX86\python.exe") {
        Write-Host "  x86: Found at $defaultX86, moving..." -ForegroundColor Yellow
        Move-Item -Path $defaultX86 -Destination $installDirX86 -Force -ErrorAction SilentlyContinue
        if (Test-Path "$installDirX86\python.exe") {
            $pythonPaths += $installDirX86
            $pythonPaths += "$installDirX86\Scripts"
            Write-Host "  x86: Moved to $installDirX86" -ForegroundColor Green
        }
    }
}

# Update PATH
if ($pythonPaths.Count -gt 0) {
    Write-Host "`n[PATH] Updating system PATH..." -ForegroundColor Cyan
    Add-PathsBatch -Paths $pythonPaths
    $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
}

# ===================== PHASE 4: x64dbg Plugin Setup =====================
Write-Host "`n[x64dbg] Setting up plugins..." -ForegroundColor Cyan

$x32PluginTarget = "$snapshotExtractDir\release\x32\plugins"
$x64PluginTarget = "$snapshotExtractDir\release\x64\plugins"

# Create plugin directories
New-DirectoriesBatch @($x32PluginTarget, $x64PluginTarget)

# Copy plugins (parallel)
$copyJobs = @()

$x32Source = "$pluginExtractDir\x32"
if (Test-Path $x32Source) {
    $copyJobs += Start-Job -ScriptBlock {
        param($src, $dest)
        Copy-Item -Path "$src\*" -Destination $dest -Recurse -Force
    } -ArgumentList $x32Source, $x32PluginTarget
    Write-Host "  Started: x32 plugins copy" -ForegroundColor Gray
}

$x64Source = "$pluginExtractDir\x64"
if (Test-Path $x64Source) {
    $copyJobs += Start-Job -ScriptBlock {
        param($src, $dest)
        Copy-Item -Path "$src\*" -Destination $dest -Recurse -Force
    } -ArgumentList $x64Source, $x64PluginTarget
    Write-Host "  Started: x64 plugins copy" -ForegroundColor Gray
}

if ($copyJobs.Count -gt 0) {
    $copyJobs | Wait-Job | Out-Null
    $copyJobs | Remove-Job -Force
    Write-Host "  Plugins copied successfully!" -ForegroundColor Green
}

# ===================== PHASE 5: Cleanup =====================
Write-Host "`n[CLEANUP] Removing temporary files..." -ForegroundColor Cyan

Remove-Item $pythonX64Installer, $pythonX86Installer, $snapshotZip, $pluginZip -Force -ErrorAction SilentlyContinue
Remove-Item $pluginExtractDir -Recurse -Force -ErrorAction SilentlyContinue

Write-Host "  Cleanup complete!" -ForegroundColor Green

# ===================== Summary =====================
$totalTimer.Stop()

Write-Host "`n=============================================" -ForegroundColor Green
Write-Host " Installation Complete!" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host "  Python x64:  $installDirX64"
Write-Host "  Python x86:  $installDirX86"
Write-Host "  x64dbg:      $snapshotExtractDir\release"
Write-Host ""
Write-Host "  Total time:  $([math]::Round($totalTimer.Elapsed.TotalSeconds, 1)) seconds" -ForegroundColor Cyan
Write-Host ""
Write-Host "  Restart your terminal for PATH changes." -ForegroundColor Yellow
Write-Host "=============================================" -ForegroundColor Green
