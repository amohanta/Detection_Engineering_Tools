# =====================================================================
# DISABLE WINDOWS 10 AUTO-UPDATES COMPLETELY
# Run as Administrator
# =====================================================================

#Requires -RunAsAdministrator

$ErrorActionPreference = "SilentlyContinue"

Write-Host "=============================================" -ForegroundColor Red
Write-Host " DISABLE WINDOWS 10 AUTO-UPDATES" -ForegroundColor Red
Write-Host "=============================================" -ForegroundColor Red
Write-Host ""
Write-Host "WARNING: This will completely disable Windows Updates." -ForegroundColor Yellow
Write-Host "You will NOT receive security patches automatically." -ForegroundColor Yellow
Write-Host ""

# ===================== 1. DISABLE UPDATE SERVICES =====================
Write-Host "[1/8] Disabling Windows Update services..." -ForegroundColor Cyan

$services = @(
    "wuauserv"          # Windows Update
    "UsoSvc"            # Update Orchestrator Service
    "WaaSMedicSvc"      # Windows Update Medic Service (self-healer)
    "BITS"              # Background Intelligent Transfer Service
    "DoSvc"             # Delivery Optimization
    "uhssvc"            # Microsoft Update Health Service
    "InstallService"    # Microsoft Store Install Service
)

foreach ($svc in $services) {
    $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
    if ($service) {
        Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
        Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue
        
        # Extra: Set to disabled via registry (more persistent)
        $regPath = "HKLM:\SYSTEM\CurrentControlSet\Services\$svc"
        Set-ItemProperty -Path $regPath -Name "Start" -Value 4 -Type DWord -ErrorAction SilentlyContinue
        
        Write-Host "  Disabled: $svc" -ForegroundColor Green
    }
}

# ===================== 2. DISABLE VIA GROUP POLICY REGISTRY =====================
Write-Host "`n[2/8] Applying Group Policy registry settings..." -ForegroundColor Cyan

# Windows Update policies
$wuPolicyPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate"
$wuAUPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU"

New-Item -Path $wuPolicyPath -Force | Out-Null
New-Item -Path $wuAUPath -Force | Out-Null

# Disable automatic updates
Set-ItemProperty -Path $wuAUPath -Name "NoAutoUpdate" -Value 1 -Type DWord
Set-ItemProperty -Path $wuAUPath -Name "AUOptions" -Value 1 -Type DWord  # 1 = Never check
Set-ItemProperty -Path $wuAUPath -Name "AutoInstallMinorUpdates" -Value 0 -Type DWord
Set-ItemProperty -Path $wuAUPath -Name "EnableFeaturedSoftware" -Value 0 -Type DWord
Set-ItemProperty -Path $wuAUPath -Name "IncludeRecommendedUpdates" -Value 0 -Type DWord

# Disable Windows Update access
Set-ItemProperty -Path $wuPolicyPath -Name "DisableWindowsUpdateAccess" -Value 1 -Type DWord
Set-ItemProperty -Path $wuPolicyPath -Name "SetDisableUXWUAccess" -Value 1 -Type DWord

# Disable driver updates
Set-ItemProperty -Path $wuPolicyPath -Name "ExcludeWUDriversInQualityUpdate" -Value 1 -Type DWord

# Disable auto-restart
Set-ItemProperty -Path $wuAUPath -Name "NoAutoRebootWithLoggedOnUsers" -Value 1 -Type DWord

Write-Host "  Group Policy settings applied" -ForegroundColor Green

# ===================== 3. DISABLE UPDATE ORCHESTRATOR =====================
Write-Host "`n[3/8] Disabling Update Orchestrator settings..." -ForegroundColor Cyan

$orchestratorPath = "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings"
if (!(Test-Path $orchestratorPath)) { New-Item -Path $orchestratorPath -Force | Out-Null }

Set-ItemProperty -Path $orchestratorPath -Name "UxOption" -Value 1 -Type DWord
Set-ItemProperty -Path $orchestratorPath -Name "IsConvergedUpdateStackEnabled" -Value 0 -Type DWord

# Disable restart notifications
$restartPath = "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX"
Set-ItemProperty -Path $restartPath -Name "IsConvergedUpdateStackEnabled" -Value 0 -Type DWord -ErrorAction SilentlyContinue

Write-Host "  Update Orchestrator disabled" -ForegroundColor Green

# ===================== 4. DISABLE SCHEDULED TASKS =====================
Write-Host "`n[4/8] Disabling Windows Update scheduled tasks..." -ForegroundColor Cyan

$taskPaths = @(
    "\Microsoft\Windows\WindowsUpdate\"
    "\Microsoft\Windows\UpdateOrchestrator\"
    "\Microsoft\Windows\WaaSMedic\"
    "\Microsoft\Windows\InstallService\"
)

foreach ($taskPath in $taskPaths) {
    $tasks = Get-ScheduledTask -TaskPath $taskPath -ErrorAction SilentlyContinue
    foreach ($task in $tasks) {
        Disable-ScheduledTask -TaskName $task.TaskName -TaskPath $task.TaskPath -ErrorAction SilentlyContinue | Out-Null
        Write-Host "  Disabled task: $($task.TaskName)" -ForegroundColor Gray
    }
}

# Specifically target the most persistent tasks
$specificTasks = @(
    @{ Path = "\Microsoft\Windows\UpdateOrchestrator\"; Name = "Schedule Scan" }
    @{ Path = "\Microsoft\Windows\UpdateOrchestrator\"; Name = "Schedule Scan Static Task" }
    @{ Path = "\Microsoft\Windows\UpdateOrchestrator\"; Name = "UpdateModelTask" }
    @{ Path = "\Microsoft\Windows\UpdateOrchestrator\"; Name = "USO_UxBroker" }
    @{ Path = "\Microsoft\Windows\WindowsUpdate\"; Name = "Scheduled Start" }
    @{ Path = "\Microsoft\Windows\WaaSMedic\"; Name = "PerformRemediation" }
)

foreach ($task in $specificTasks) {
    Disable-ScheduledTask -TaskPath $task.Path -TaskName $task.Name -ErrorAction SilentlyContinue | Out-Null
}

Write-Host "  Scheduled tasks disabled" -ForegroundColor Green

# ===================== 5. BLOCK UPDATE SERVERS VIA HOSTS =====================
Write-Host "`n[5/8] Blocking Windows Update servers in hosts file..." -ForegroundColor Cyan

$hostsFile = "$env:SystemRoot\System32\drivers\etc\hosts"
$updateServers = @(
    "0.0.0.0 update.microsoft.com"
    "0.0.0.0 windowsupdate.microsoft.com"
    "0.0.0.0 windowsupdate.com"
    "0.0.0.0 download.windowsupdate.com"
    "0.0.0.0 download.microsoft.com"
    "0.0.0.0 wustat.windows.com"
    "0.0.0.0 ntservicepack.microsoft.com"
    "0.0.0.0 stats.microsoft.com"
    "0.0.0.0 fe2.update.microsoft.com"
    "0.0.0.0 fe3.delivery.mp.microsoft.com"
    "0.0.0.0 sls.update.microsoft.com"
    "0.0.0.0 emdl.ws.microsoft.com"
)

# Backup hosts file
Copy-Item $hostsFile "$hostsFile.backup" -Force -ErrorAction SilentlyContinue

$hostsContent = Get-Content $hostsFile -ErrorAction SilentlyContinue
$added = 0

# Add marker comment
if ($hostsContent -notcontains "# Windows Update Block - Added by script") {
    Add-Content -Path $hostsFile -Value "`n# Windows Update Block - Added by script"
}

foreach ($server in $updateServers) {
    if ($hostsContent -notcontains $server) {
        Add-Content -Path $hostsFile -Value $server
        $added++
    }
}

Write-Host "  Added $added entries to hosts file" -ForegroundColor Green

# ===================== 6. DISABLE WINDOWS UPDATE MEDIC (SELF-HEALER) =====================
Write-Host "`n[6/8] Disabling Windows Update Medic (self-repair)..." -ForegroundColor Cyan

# Take ownership and disable WaaSMedic
$medicPath = "HKLM:\SYSTEM\CurrentControlSet\Services\WaaSMedicSvc"
if (Test-Path $medicPath) {
    # Disable start
    Set-ItemProperty -Path $medicPath -Name "Start" -Value 4 -Type DWord -ErrorAction SilentlyContinue
    
    # Remove recovery options
    Set-ItemProperty -Path $medicPath -Name "FailureActions" -Value ([byte[]](0x00)) -Type Binary -ErrorAction SilentlyContinue
}

# Disable via Task Scheduler XML (more persistent)
$medicTaskFile = "$env:SystemRoot\System32\Tasks\Microsoft\Windows\WaaSMedic\PerformRemediation"
if (Test-Path $medicTaskFile) {
    takeown /F $medicTaskFile /A 2>$null | Out-Null
    icacls $medicTaskFile /grant Administrators:F 2>$null | Out-Null
    Remove-Item $medicTaskFile -Force -ErrorAction SilentlyContinue
}

Write-Host "  Windows Update Medic disabled" -ForegroundColor Green

# ===================== 7. DISABLE DELIVERY OPTIMIZATION =====================
Write-Host "`n[7/8] Disabling Delivery Optimization (P2P updates)..." -ForegroundColor Cyan

$doPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeliveryOptimization"
if (!(Test-Path $doPath)) { New-Item -Path $doPath -Force | Out-Null }

Set-ItemProperty -Path $doPath -Name "DODownloadMode" -Value 0 -Type DWord

$doPath2 = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\DeliveryOptimization\Config"
if (!(Test-Path $doPath2)) { New-Item -Path $doPath2 -Force | Out-Null }
Set-ItemProperty -Path $doPath2 -Name "DODownloadMode" -Value 0 -Type DWord

Write-Host "  Delivery Optimization disabled" -ForegroundColor Green

# ===================== 8. DISABLE STORE AUTO-UPDATES =====================
Write-Host "`n[8/8] Disabling Microsoft Store auto-updates..." -ForegroundColor Cyan

$storePath = "HKLM:\SOFTWARE\Policies\Microsoft\WindowsStore"
if (!(Test-Path $storePath)) { New-Item -Path $storePath -Force | Out-Null }

Set-ItemProperty -Path $storePath -Name "AutoDownload" -Value 2 -Type DWord  # 2 = Always off
Set-ItemProperty -Path $storePath -Name "DisableOSUpgrade" -Value 1 -Type DWord

# User-level store settings
$storeUserPath = "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\ContentDeliveryManager"
if (Test-Path $storeUserPath) {
    Set-ItemProperty -Path $storeUserPath -Name "SilentInstalledAppsEnabled" -Value 0 -Type DWord
}

Write-Host "  Store auto-updates disabled" -ForegroundColor Green

# ===================== CLEAR UPDATE CACHE =====================
Write-Host "`n[CLEANUP] Clearing Windows Update cache..." -ForegroundColor Cyan

Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue
Stop-Service -Name BITS -Force -ErrorAction SilentlyContinue

Remove-Item -Path "C:\Windows\SoftwareDistribution\*" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path "C:\Windows\System32\catroot2\*" -Recurse -Force -ErrorAction SilentlyContinue

Write-Host "  Update cache cleared" -ForegroundColor Green

# ===================== OPTIONAL: FIREWALL RULES =====================
Write-Host "`n[OPTIONAL] Creating firewall rules to block updates..." -ForegroundColor Cyan

# Block Windows Update executable
$wuExe = "$env:SystemRoot\System32\wuauclt.exe"
if (Test-Path $wuExe) {
    netsh advfirewall firewall add rule name="Block Windows Update" dir=out program="$wuExe" action=block 2>$null | Out-Null
}

# Block Update Orchestrator
$usoExe = "$env:SystemRoot\System32\usoclient.exe"
if (Test-Path $usoExe) {
    netsh advfirewall firewall add rule name="Block Update Orchestrator" dir=out program="$usoExe" action=block 2>$null | Out-Null
}

Write-Host "  Firewall rules added" -ForegroundColor Green

# ===================== SUMMARY =====================
Write-Host "`n=============================================" -ForegroundColor Green
Write-Host " WINDOWS AUTO-UPDATES DISABLED!" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host ""
Write-Host "Changes made:" -ForegroundColor White
Write-Host "  [X] Windows Update services disabled" -ForegroundColor Gray
Write-Host "  [X] Group Policy settings applied" -ForegroundColor Gray
Write-Host "  [X] Update Orchestrator disabled" -ForegroundColor Gray
Write-Host "  [X] Scheduled tasks disabled" -ForegroundColor Gray
Write-Host "  [X] Update servers blocked in hosts" -ForegroundColor Gray
Write-Host "  [X] Windows Update Medic disabled" -ForegroundColor Gray
Write-Host "  [X] Delivery Optimization disabled" -ForegroundColor Gray
Write-Host "  [X] Store auto-updates disabled" -ForegroundColor Gray
Write-Host "  [X] Update cache cleared" -ForegroundColor Gray
Write-Host "  [X] Firewall rules added" -ForegroundColor Gray
Write-Host ""
Write-Host "IMPORTANT:" -ForegroundColor Yellow
Write-Host "  - Restart your computer for all changes to take effect" -ForegroundColor Yellow
Write-Host "  - You will NOT receive security updates automatically" -ForegroundColor Yellow
Write-Host "  - To re-enable updates, run the companion enable script" -ForegroundColor Yellow
Write-Host ""
Write-Host "=============================================" -ForegroundColor Green

$restart = Read-Host "Restart now? (Y/N)"
if ($restart -eq "Y" -or $restart -eq "y") {
    Restart-Computer -Force
}
