# URLs for Python installers
$pythonX64Url = "https://www.python.org/ftp/python/3.8.0/python-3.8.0-amd64.exe"
$pythonX86Url = "https://www.python.org/ftp/python/3.8.0/python-3.8.0.exe"

# Local temp paths for installers
$pythonX64Installer = "$env:TEMP\python-3.8.0-amd64.exe"
$pythonX86Installer = "$env:TEMP\python-3.8.0.exe"

# Target installation directories
$installDirX64 = "C:\python-3.8-x64"
$installDirX86 = "C:\python-3.8-x86"

# Function to download files in parallel using BITS
function Download-FilesParallel {
    Write-Host "Starting parallel downloads..." -ForegroundColor Yellow
    
    Get-BitsTransfer | Where-Object {$_.DisplayName -like "*Python*"} | Remove-BitsTransfer -ErrorAction SilentlyContinue
    
    try {
        $job1 = Start-BitsTransfer -Source $pythonX64Url -Destination $pythonX64Installer -DisplayName "Python-x64" -Asynchronous -Priority High
        $job2 = Start-BitsTransfer -Source $pythonX86Url -Destination $pythonX86Installer -DisplayName "Python-x86" -Asynchronous -Priority High
        
        $jobs = @($job1, $job2)
        
        while ($true) {
            $allDone = $true
            foreach ($job in $jobs) {
                if ($job.JobState -in @("Connecting", "Transferring", "Queued")) {
                    $allDone = $false
                }
            }
            if ($allDone) { break }
            Start-Sleep -Milliseconds 500
        }
        
        $success = $true
        foreach ($job in $jobs) {
            if ($job.JobState -eq "Transferred") {
                Complete-BitsTransfer -BitsJob $job
                Write-Host "$($job.DisplayName): Download completed" -ForegroundColor Green
            } else {
                Write-Host "$($job.DisplayName): Download failed" -ForegroundColor Red
                $job | Remove-BitsTransfer -ErrorAction SilentlyContinue
                $success = $false
            }
        }
        
        return $success
    } catch {
        Write-Host "Download error: $_" -ForegroundColor Red
        return $false
    }
}

# Function to add paths to system PATH
function Add-PathsBatch {
    param([string[]]$Paths)
    
    $currentPath = [Environment]::GetEnvironmentVariable("Path", [EnvironmentVariableTarget]::Machine)
    $pathsToAdd = @()
    
    foreach ($p in $Paths) {
        if ((Test-Path $p) -and ($currentPath -notlike "*$p*")) {
            $pathsToAdd += $p
            Write-Host "Adding to PATH: $p" -ForegroundColor Green
        }
    }
    
    if ($pathsToAdd.Count -gt 0) {
        $newPathValue = "$currentPath;$($pathsToAdd -join ';')"
        [Environment]::SetEnvironmentVariable("Path", $newPathValue, [EnvironmentVariableTarget]::Machine)
        return $true
    }
    return $false
}

# Function to install Python using alternative method
function Install-PythonToPath {
    param(
        [string]$Installer,
        [string]$TargetDir,
        [string]$Label
    )
    
    Write-Host "`nInstalling $Label..." -ForegroundColor Cyan
    
    # Remove existing installation if present
    if (Test-Path $TargetDir) {
        Write-Host "  Removing existing installation at $TargetDir" -ForegroundColor Yellow
        Remove-Item -Path $TargetDir -Recurse -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
    }
    
    # Method 1: Try standard install with explicit TargetDir
    Write-Host "  Attempting installation..." -ForegroundColor Gray
    
    # The key is to NOT use InstallAllUsers when specifying custom TargetDir
    # Use per-user install which respects TargetDir better
    $process = Start-Process -FilePath $Installer -ArgumentList @(
        "/quiet",
        "InstallAllUsers=0",
        "TargetDir=$TargetDir",
        "DefaultJustForMeTargetDir=$TargetDir",
        "AssociateFiles=0",
        "CompileAll=0",
        "PrependPath=0",
        "Include_doc=0",
        "Include_test=0",
        "Include_launcher=0"
    ) -Wait -PassThru
    
    Write-Host "  Installer exit code: $($process.ExitCode)" -ForegroundColor Gray
    
    # Check if it worked
    Start-Sleep -Seconds 3
    
    if (Test-Path "$TargetDir\python.exe") {
        $version = & "$TargetDir\python.exe" --version 2>&1
        Write-Host "  SUCCESS: $version installed at $TargetDir" -ForegroundColor Green
        return $true
    }
    
    # Method 2: If that didn't work, find where it installed and move it
    Write-Host "  Standard install failed, searching for installation..." -ForegroundColor Yellow
    
    $searchLocations = @(
        "$env:LOCALAPPDATA\Programs\Python\Python38",
        "$env:LOCALAPPDATA\Programs\Python\Python38-32",
        "$env:ProgramFiles\Python38",
        "${env:ProgramFiles(x86)}\Python38",
        "C:\Python38",
        "C:\Users\$env:USERNAME\AppData\Local\Programs\Python\Python38",
        "C:\Users\$env:USERNAME\AppData\Local\Programs\Python\Python38-32"
    )
    
    $foundPath = $null
    foreach ($loc in $searchLocations) {
        if (Test-Path "$loc\python.exe") {
            $foundPath = $loc
            Write-Host "  Found installation at: $loc" -ForegroundColor Cyan
            break
        }
    }
    
    if ($foundPath) {
        Write-Host "  Moving installation to $TargetDir..." -ForegroundColor Yellow
        
        # Ensure target parent exists
        $parentDir = Split-Path $TargetDir -Parent
        if (-not (Test-Path $parentDir)) {
            New-Item -ItemType Directory -Path $parentDir -Force | Out-Null
        }
        
        # Move the installation
        try {
            Move-Item -Path $foundPath -Destination $TargetDir -Force
            
            if (Test-Path "$TargetDir\python.exe") {
                $version = & "$TargetDir\python.exe" --version 2>&1
                Write-Host "  SUCCESS: Moved $version to $TargetDir" -ForegroundColor Green
                return $true
            }
        } catch {
            Write-Host "  Failed to move: $_" -ForegroundColor Red
            
            # Try copy instead
            Write-Host "  Trying copy instead..." -ForegroundColor Yellow
            Copy-Item -Path $foundPath -Destination $TargetDir -Recurse -Force
            
            if (Test-Path "$TargetDir\python.exe") {
                $version = & "$TargetDir\python.exe" --version 2>&1
                Write-Host "  SUCCESS: Copied $version to $TargetDir" -ForegroundColor Green
                
                # Clean up original
                Remove-Item -Path $foundPath -Recurse -Force -ErrorAction SilentlyContinue
                return $true
            }
        }
    }
    
    Write-Host "  FAILED: Could not install $Label to $TargetDir" -ForegroundColor Red
    return $false
}

# Main execution
Write-Host "=== Python 3.8 Installation Script ===" -ForegroundColor Yellow
Write-Host ""

# Download
$downloadSuccess = Download-FilesParallel

if (-not $downloadSuccess) {
    Write-Host "Download failed. Aborting." -ForegroundColor Red
    exit 1
}

# Verify downloads
if (-not (Test-Path $pythonX64Installer) -or -not (Test-Path $pythonX86Installer)) {
    Write-Host "Installer files not found!" -ForegroundColor Red
    exit 1
}

Write-Host "`nStarting installations..." -ForegroundColor Yellow

# Install x64
$x64Ok = Install-PythonToPath -Installer $pythonX64Installer -TargetDir $installDirX64 -Label "Python 3.8 x64"

# Install x86
$x86Ok = Install-PythonToPath -Installer $pythonX86Installer -TargetDir $installDirX86 -Label "Python 3.8 x86"

# Results
Write-Host "`n========================================" -ForegroundColor Cyan

if ($x64Ok -and $x86Ok) {
    Write-Host "Both installations successful!" -ForegroundColor Green
    
    # Update PATH
    Write-Host "`nUpdating system PATH..." -ForegroundColor Yellow
    
    $pathsToAdd = @(
        $installDirX64,
        "$installDirX64\Scripts",
        $installDirX86,
        "$installDirX86\Scripts"
    )
    
    Add-PathsBatch -Paths $pathsToAdd
    
    # Refresh current session
    $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
    
    Write-Host "`n========================================" -ForegroundColor Green
    Write-Host "Installation complete!" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
    Write-Host "  Python x64: $installDirX64"
    Write-Host "  Python x86: $installDirX86"
    Write-Host "`nRestart your terminal for PATH changes." -ForegroundColor Yellow
    
} elseif ($x64Ok -or $x86Ok) {
    Write-Host "Partial success" -ForegroundColor Yellow
    if ($x64Ok) { Write-Host "  Python x64: OK at $installDirX64" -ForegroundColor Green }
    if ($x86Ok) { Write-Host "  Python x86: OK at $installDirX86" -ForegroundColor Green }
    
} else {
    Write-Host "Installation failed!" -ForegroundColor Red
    Write-Host "`nTry manual installation:" -ForegroundColor Yellow
    Write-Host "  1. Run: $pythonX64Installer" -ForegroundColor Gray
    Write-Host "  2. Click 'Customize installation'" -ForegroundColor Gray
    Write-Host "  3. Click 'Next'" -ForegroundColor Gray
    Write-Host "  4. Change install location to: $installDirX64" -ForegroundColor Gray
    Write-Host "  5. Click 'Install'" -ForegroundColor Gray
}

Write-Host "========================================" -ForegroundColor Cyan

# Cleanup
Write-Host "`nCleaning up..." -ForegroundColor Gray
Remove-Item $pythonX64Installer -Force -ErrorAction SilentlyContinue
Remove-Item $pythonX86Installer -Force -ErrorAction SilentlyContinue

Write-Host "Done." -ForegroundColor Green
