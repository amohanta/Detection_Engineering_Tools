# =====================================================================
# OPTIMIZED: .NET Tools (dnSpy, de4dot)
# - Parallel downloads using WebClient
# - Parallel extractions
# =====================================================================

$ErrorActionPreference = "SilentlyContinue"

# ===================== Configuration =====================
$baseDir = "C:\tools\dotnet"

$tools = @(
    @{ Name = "dnSpy-32bit"; Url = "https://github.com/dnSpyEx/dnSpy/releases/download/v6.4.0/dnSpy-net-win32.zip"; Zip = "$env:TEMP\dnSpy32.zip"; Dest = "$baseDir\dnSpy_32bit" }
    @{ Name = "dnSpy-64bit"; Url = "https://github.com/dnSpyEx/dnSpy/releases/download/v6.4.0/dnSpy-net-win64.zip"; Zip = "$env:TEMP\dnSpy64.zip"; Dest = "$baseDir\dnSpy_64bit" }
    @{ Name = "de4dot-cex"; Url = "https://github.com/ViRb3/de4dot-cex/releases/download/v4.0.0/de4dot-cex.zip"; Zip = "$env:TEMP\de4dot.zip"; Dest = "$baseDir\de4dot-cex" }
)

# ===================== Helper Functions =====================
function Start-ParallelDownloads {
    param([hashtable[]]$Downloads)
    
    Write-Host "`n[DOWNLOAD] Starting $($Downloads.Count) parallel downloads..." -ForegroundColor Cyan
    
    $jobs = @()
    foreach ($dl in $Downloads) {
        $jobs += Start-Job -ScriptBlock {
            param($url, $path)
            try {
                $webClient = New-Object System.Net.WebClient
                $webClient.DownloadFile($url, $path)
                return @{ Success = $true; Path = $path }
            } catch {
                return @{ Success = $false; Path = $path; Error = $_.Exception.Message }
            }
        } -ArgumentList $dl.Url, $dl.Zip
        Write-Host "  Started: $($dl.Name)" -ForegroundColor Gray
    }
    
    while (($jobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
        $completed = ($jobs | Where-Object { $_.State -eq 'Completed' }).Count
        Write-Host "`r  Progress: $completed/$($jobs.Count) complete    " -NoNewline -ForegroundColor Yellow
        Start-Sleep -Milliseconds 300
    }
    Write-Host ""
    
    $results = $jobs | Receive-Job -Wait
    $jobs | Remove-Job -Force
    
    $allSuccess = $true
    foreach ($result in $results) {
        if ($result.Success) {
            Write-Host "  OK: $(Split-Path $result.Path -Leaf)" -ForegroundColor Green
        } else {
            Write-Host "  FAILED: $(Split-Path $result.Path -Leaf)" -ForegroundColor Red
            $allSuccess = $false
        }
    }
    return $allSuccess
}

# ===================== Main Script =====================
$timer = [System.Diagnostics.Stopwatch]::StartNew()

Write-Host "=============================================" -ForegroundColor Cyan
Write-Host " .NET Tools Installer (Optimized)" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan

# Create directories
Write-Host "`n[SETUP] Creating directories..." -ForegroundColor Cyan
New-Item -Path $baseDir -ItemType Directory -Force | Out-Null
$tools | ForEach-Object { New-Item -Path $_.Dest -ItemType Directory -Force | Out-Null }

# ===================== Phase 1: Parallel Downloads =====================
Start-ParallelDownloads -Downloads $tools

# ===================== Phase 2: Parallel Extractions =====================
Write-Host "`n[EXTRACT] Starting parallel extractions..." -ForegroundColor Cyan

$extractJobs = @()
foreach ($tool in $tools) {
    $extractJobs += Start-Job -ScriptBlock {
        param($zip, $dest)
        Expand-Archive -LiteralPath $zip -DestinationPath $dest -Force
        return @{ Success = $true; Name = (Split-Path $dest -Leaf) }
    } -ArgumentList $tool.Zip, $tool.Dest
    Write-Host "  Started: $($tool.Name)" -ForegroundColor Gray
}

# Wait for extractions
while (($extractJobs | Where-Object { $_.State -eq 'Running' }).Count -gt 0) {
    $completed = ($extractJobs | Where-Object { $_.State -eq 'Completed' }).Count
    Write-Host "`r  Progress: $completed/$($extractJobs.Count) complete    " -NoNewline -ForegroundColor Yellow
    Start-Sleep -Milliseconds 300
}
Write-Host ""

$extractJobs | Receive-Job -Wait | Out-Null
$extractJobs | Remove-Job -Force

Write-Host "  All extractions complete!" -ForegroundColor Green

# ===================== Phase 3: Cleanup =====================
Write-Host "`n[CLEANUP] Removing ZIP files..." -ForegroundColor Cyan
$tools | ForEach-Object { Remove-Item $_.Zip -Force -ErrorAction SilentlyContinue }

# ===================== Summary =====================
$timer.Stop()

Write-Host "`n=============================================" -ForegroundColor Green
Write-Host " Complete! Time: $([math]::Round($timer.Elapsed.TotalSeconds, 1))s" -ForegroundColor Green
Write-Host "=============================================" -ForegroundColor Green
Write-Host "  Tools installed to: $baseDir"
Write-Host "  - dnSpy 32-bit"
Write-Host "  - dnSpy 64-bit"
Write-Host "  - de4dot-cex"
